<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apostas ‚Äî N√∫meros da Sorte</title>
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            glow: "0 0 0 2px rgb(59 130 246 / 0.15), 0 0 0 6px rgb(59 130 246 / 0.08)"
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root { --brand:#2563eb; --brand2:#7c3aed; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .num:hover { transform: translateY(-1px); }
    .badge { position:absolute; top:.4rem; right:.4rem; }
    .tw-gradient { background-image: linear-gradient(135deg, var(--brand), var(--brand2)); }
    .floating { animation: floating 6s ease-in-out infinite; }
    @keyframes floating { 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-6px)} }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <header class="tw-gradient text-white shadow-lg">
    <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold">üé≤ N√∫meros da Sorte</h1>
        <marquee class="mt-2 text-sm font-semibold text-yellow-200">üéâ Sorteio todo S√°bado √†s 11:00 da manh√£ üéâ</marquee>
        <p class="opacity-90">Escolha seu n√∫mero, fa√ßa o Pix e anexe o comprovante. Interface r√°pida e responsiva.</p>
      </div>
      <!-- WhatsApp do topo removido a pedido -->
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Info Cards -->
    <section class="grid sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow">
        <div class="text-sm text-slate-500">Valor da aposta</div>
        <div id="valorAposta" class="text-2xl font-extrabold text-blue-600 dark:text-blue-400">R$ 2,00</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow">
        <div class="text-sm text-slate-500">Pr√™mio do ganhador</div>
        <div id="premioValor" class="text-2xl font-extrabold text-emerald-600">R$ 150,00</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow">
        <div class="text-sm text-slate-500">Pr√≥ximo sorteio</div>
        <div id="contador" class="text-xl font-bold">calculando‚Ä¶</div>
      </div>
    </section>

    <!-- Grid + Form -->
    <section class="grid lg:grid-cols-3 gap-6">
      <!-- Grid -->
      <div class="lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-bold">Escolha um n√∫mero dispon√≠vel</h2>
          <div class="text-sm text-slate-500">Toque para selecionar</div>
        </div>
        <div id="grid" class="grid grid-cols-5 sm:grid-cols-10 gap-2"></div>
        <div class="mt-3 text-xs text-slate-500">Legenda: 
          <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-white border border-slate-200 inline-block"></span> Livre</span> ¬∑ 
          <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-400 inline-block"></span> Reservado</span> ¬∑
          <span class="inline-flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-500 inline-block"></span> Pago</span>
        </div>
      </div>

      <!-- Formul√°rio -->
      <div>
        <form id="form" class="bg-white dark:bg-slate-800 rounded-2xl shadow p-4 space-y-3" enctype="multipart/form-data">
          <h3 class="text-lg font-semibold">Finalize sua participa√ß√£o</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-500">Nome</label>
              <input required name="nome" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:outline-none focus:ring-4 focus:ring-blue-500/20" placeholder="Seu nome">
            </div>
            <div>
              <label class="text-sm text-slate-500">WhatsApp</label>
              <input required name="whats" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="DDD + n√∫mero">
            </div>
          </div>

          <div>
            <label class="text-sm text-slate-500">N√∫mero escolhido</label>
            <input id="numEscolhido" name="numero" required class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="Selecione no grid ao lado" readonly>
          </div>

          <div class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl p-3">
            <div class="text-sm font-semibold mb-2">Pagamento via Pix</div>
            <div class="text-sm">Chave (CPF): <strong id="pixChave">117.786.576-99</strong></div>
            <button type="button" id="copiarPix" class="mt-2 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-blue-600 text-white font-semibold hover:shadow-glow">üìã Copiar chave Pix</button>
          </div>

          <div>
            <label class="text-sm text-slate-500">Anexe o comprovante (imagem ou PDF)</label>
            <input id="file" name="file" type="file" accept="image/*,.pdf" required class="w-full mt-1 block text-sm file:mr-3 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-slate-100 dark:file:bg-slate-700 file:text-slate-700 dark:file:text-slate-100 hover:file:bg-slate-200 dark:hover:file:bg-slate-600">
            <div id="preview" class="mt-2 text-xs text-slate-500"></div>
          </div>

          <button class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white font-extrabold hover:shadow-glow">‚úÖ Enviar participa√ß√£o</button>
          <p class="text-xs text-slate-500">Ao enviar, seu n√∫mero aparece como <strong>Reservado</strong> e aguardar√° valida√ß√£o do organizador.</p>
        </form>

        <div id="success" class="hidden mt-4 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-2xl p-4">
          <div class="flex items-start gap-3">
            <div class="text-2xl">üéâ</div>
            <div>
              <div class="font-semibold">Participa√ß√£o enviada!</div>
              <div class="text-sm text-slate-600 dark:text-slate-300">Seu n√∫mero foi reservado e apareceu no cart√£o abaixo. Voc√™ tamb√©m pode baixar seu cart√£o de participa√ß√£o.</div>
            </div>
          </div>
        </div>

        <!-- Cart√£o de participa√ß√£o -->
        <div id="cardWrap" class="hidden mt-4">
          <div id="card" class="relative rounded-2xl p-4 tw-gradient text-white shadow-xl floating">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs opacity-75">Cart√£o de Participa√ß√£o</div>
                <div id="cardNome" class="text-xl font-extrabold leading-tight"></div>
                <div id="cardWhats" class="text-sm opacity-90"></div>
              </div>
              <div class="text-right">
                <div class="text-xs opacity-75">N√∫mero escolhido</div>
                <div id="cardNumero" class="text-5xl font-black drop-shadow">‚Äì</div>
              </div>
            </div>
            <div class="mt-3 text-xs opacity-90" id="cardObs"></div>
            <div class="mt-3 bg-white/10 rounded-xl p-3">
              <div class="text-xs mb-1">Comprovante:</div>
              <div id="cardComp" class="text-xs">Nenhum arquivo</div>
            </div>
            <div class="absolute bottom-3 right-4 text-xs opacity-80">Ref <span id="cardRef">‚Äî</span></div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="baixarCard" class="px-3 py-2 rounded-xl bg-white text-slate-900 font-semibold shadow">‚¨áÔ∏è Baixar comprovante (PNG)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Lista (organizador) -->
    <section class="mt-10">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Participa√ß√µes (este dispositivo)</h3>
        <div class="text-sm flex items-center gap-2">Senha organizador: <input id="senhaOrg" type="password" class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-slate-100 bg-white dark:bg-slate-900 w-32"></div>
        <button id="exportar" class="hidden text-sm px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700">Exportar JSON</button>
      </div>
      <div id="lista" class="bg-white dark:bg-slate-800 rounded-2xl shadow divide-y divide-slate-100 dark:divide-slate-700"></div>
      <p class="text-xs mt-2 text-slate-500">Obs.: os dados ficam salvos apenas neste dispositivo (localStorage). Para uso multiusu√°rio/online, conecte com um backend.</p>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
    ¬© 2025 ‚Äî Use respons√°vel. Ao apostar, voc√™ concorda com as regras do organizador.
  </footer>

<script>
// ===== CONFIG =====
const TOTAL = 100;
const VALOR_APOSTA = "R$ 2,00";
const PREMIO = "R$ 150,00";
const SORTEIO = { diaSemana: 6, hora: 11, minuto: 0 }; // S√°bado 11:00
const PIX_CHAVE = "117.786.576-99";
// ==================

document.getElementById("valorAposta").textContent = VALOR_APOSTA;
document.getElementById("premioValor").textContent = PREMIO;
document.getElementById("pixChave").textContent = PIX_CHAVE;

const grid = document.getElementById("grid");
const form = document.getElementById("form");
const lista = document.getElementById("lista");
const numEscolhido = document.getElementById("numEscolhido");
const preview = document.getElementById("preview");
const copiarPix = document.getElementById("copiarPix");
const exportar = document.getElementById("exportar");

const storageKey = "apostas-participacoes-v1";
const reservasKey = "apostas-reservas-v1";

let participacoes = JSON.parse(localStorage.getItem(storageKey) || "[]");
let reservas = new Set(JSON.parse(localStorage.getItem(reservasKey) || "[]"));

// Gerar grid
for (let i = 1; i <= TOTAL; i++) {
  const d = document.createElement("button");
  d.className = "relative num bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-center font-bold shadow-sm hover:shadow transition";
  d.textContent = i;
  d.dataset.num = i;
  d.id = `num-${i}`;
  d.addEventListener("click", () => selecionarNumero(i));
  grid.appendChild(d);
}
renderStatus();

function selecionarNumero(n) {
  if (reservas.has(n)) return alert("N√∫mero j√° reservado neste dispositivo.");
  if (participacoes.find(p => p.numero === n && p.status !== "cancelado")) return alert("N√∫mero j√° enviado neste dispositivo.");
  numEscolhido.value = n;
  document.getElementById(`num-${n}`).classList.add("ring-2","ring-blue-500","shadow-glow");
  setTimeout(() => document.getElementById(`num-${n}`).classList.remove("ring-2","ring-blue-500","shadow-glow"), 1000);
}

document.getElementById("file").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) { preview.innerHTML = ""; return; }
  if (f.type.startsWith("image/")) {
    const r = new FileReader();
    r.onload = () => { preview.innerHTML = `<img src="${r.result}" alt="comprovante" class="max-h-40 rounded-xl shadow border border-slate-200">`; };
    r.readAsDataURL(f);
  } else {
    preview.textContent = `Arquivo selecionado: ${f.name}`;
  }
});

copiarPix.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(PIX_CHAVE.replace(/[^\d]/g,''));
    copiarPix.textContent = "‚úÖ Chave copiada!";
    setTimeout(() => copiarPix.textContent = "üìã Copiar chave Pix", 1500);
  } catch { alert("N√£o foi poss√≠vel copiar."); }
});

// ===== SUBMIT para PHP + manter UI local =====
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = new FormData(form);
  const nome = data.get("nome").toString().trim();
  const whats = data.get("whats").toString().trim();
  const numero = parseInt(data.get("numero"));
  const file = document.getElementById("file").files[0];
  if (!numero || Number.isNaN(numero)) return alert("Selecione um n√∫mero no grid.");
  if (!file) return alert("Anexe o comprovante.");

  // Enviar para salvar.php
  let result;
  try {
    const resp = await fetch("salvar.php", { method: "POST", body: data });
    result = await resp.json();
    if (result.status !== "ok") throw new Error(result.msg || "Erro ao salvar no servidor.");
  } catch (err) {
    alert("Falha no envio para o servidor: " + err.message);
    return;
  }

  // Converter imagem para DataURL (para visual do cart√£o)
  let comp = { name: file.name, type: file.type, dataURL: null, path: result?.dados?.comprovante || null };
  if (file.type.startsWith("image/")) {
    comp.dataURL = await fileToDataURL(file);
  }

  const ref = result?.dados?.ref || `P${Date.now().toString(36)}`;
  const entrada = { ref, nome, whats, numero, comprovante: comp, status: "reservado", ts: new Date().toISOString() };
  participacoes.push(entrada);
  reservas.add(numero);
  persist();
  form.reset();
  numEscolhido.value = numero; // mant√©m n√∫mero no cart√£o
  mostrarSucesso(entrada);
  renderStatus();
  renderLista();
});

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function persist() {
  localStorage.setItem(storageKey, JSON.stringify(participacoes));
  localStorage.setItem(reservasKey, JSON.stringify(Array.from(reservas)));
}

function renderStatus() {
  // limpar estilos
  for (let i=1;i<=TOTAL;i++) {
    const el = document.getElementById(`num-${i}`);
    el.classList.remove("bg-amber-400","text-white","bg-emerald-500");
    el.classList.add("bg-white","dark:bg-slate-800");
    el.querySelector(".badge")?.remove();
  }
  // aplicar estados
  reservas.forEach(n => {
    const el = document.getElementById(`num-${n}`);
    el.classList.remove("bg-white","dark:bg-slate-800");
    el.classList.add("bg-amber-400","text-white");
    el.insertAdjacentHTML("beforeend", `<span class="badge text-[10px] bg-black/50 px-2 py-0.5 rounded-full">Reservado</span>`);
  });
  participacoes.forEach(p => {
    if (p.status === "pago") {
      const el = document.getElementById(`num-${p.numero}`);
      el.classList.remove("bg-white","dark:bg-slate-800","bg-amber-400");
      el.classList.add("bg-emerald-500","text-white");
      el.querySelector(".badge")?.remove();
      el.insertAdjacentHTML("beforeend", `<span class="badge text-[10px] bg-black/50 px-2 py-0.5 rounded-full">Pago</span>`);
    }
  });
}

function renderLista() {
  lista.innerHTML = "";
  if (participacoes.length === 0) {
    lista.innerHTML = `<div class="p-4 text-sm text-slate-500">Nenhuma participa√ß√£o enviada ainda.</div>`;
    return;
  }
  participacoes.slice().reverse().forEach(p => {
    const linha = document.createElement("div");
    linha.className = "p-4 flex items-center justify-between gap-3";
    linha.innerHTML = `
      <div class="min-w-0">
        <div class="font-semibold truncate">${p.nome} ‚Äî n¬∫ ${p.numero} <span class="text-xs px-2 py-0.5 rounded-full ${p.status==='pago'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'}">${p.status}</span></div>
        <div class="text-xs text-slate-500 truncate">${new Date(p.ts).toLocaleString()} ‚Ä¢ ${p.whats}</div>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <button data-ref="${p.ref}" class="ver px-3 py-1.5 text-sm rounded-xl border">Ver</button>
        ${orgLiberado?`<button data-ref="${p.ref}" class="pago px-3 py-1.5 text-sm rounded-xl bg-emerald-600 text-white">Marcar pago</button><button data-ref="${p.ref}" class="apagar px-3 py-1.5 text-sm rounded-xl bg-rose-600 text-white">Apagar</button>`:""}
      </div>
    `;
    lista.appendChild(linha);
  });

  lista.querySelectorAll(".ver").forEach(b=> b.addEventListener("click",()=>{
    const p = participacoes.find(x=>x.ref===b.dataset.ref);
    if (p) mostrarSucesso(p);
    window.scrollTo({ top: document.getElementById("cardWrap").offsetTop - 20, behavior: "smooth" });
  }));
  lista.querySelectorAll(".pago").forEach(b=> b.addEventListener("click",()=>{
    const p = participacoes.find(x=>x.ref===b.dataset.ref);
    if (!p) return;
    p.status = "pago";
    persist(); renderStatus(); renderLista();
  }));
  lista.querySelectorAll(".apagar").forEach(b=> b.addEventListener("click",()=>{
    const idx = participacoes.findIndex(x=>x.ref===b.dataset.ref);
    if (idx>=0) {
      reservas.delete(participacoes[idx].numero);
      participacoes.splice(idx,1);
      persist(); renderStatus(); renderLista();
    }
  }));
}

function mostrarSucesso(entrada) {
  document.getElementById("success").classList.remove("hidden");
  const wrap = document.getElementById("cardWrap");
  wrap.classList.remove("hidden");
  document.getElementById("cardNome").textContent = entrada.nome;
  document.getElementById("cardWhats").textContent = "";
  document.getElementById("cardNumero").textContent = entrada.numero;
  document.getElementById("cardRef").textContent = entrada.ref;
  document.getElementById("cardObs").textContent = `Valor pago: ${VALOR_APOSTA} ‚Ä¢ Pr√™mio: ${PREMIO}`;
  const comp = entrada.comprovante;
  if (comp?.dataURL) {
    document.getElementById("cardComp").innerHTML = `<img src="${comp.dataURL}" alt="comprovante" class="max-h-36 rounded-lg border border-white/30">`;
  } else if (comp?.name) {
    document.getElementById("cardComp").textContent = "Arquivo: " + comp.name;
  } else {
    document.getElementById("cardComp").textContent = "‚Äî";
  }
}

// Baixar card como imagem
document.getElementById("baixarCard").addEventListener("click", async () => {
  const card = document.getElementById("card");
  const canvas = await html2canvas(card, { scale: 2, backgroundColor: null });
  const link = document.createElement("a");
  link.download = "comprovante-participacao.png";
  link.href = canvas.toDataURL();
  link.click();
});

// Exportar JSON
exportar.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(participacoes, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "participacoes.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// Contador
function proximoSabado11() {
  const agora = new Date();
  const dia = agora.getDay();
  const prox = new Date(agora);
  prox.setDate(agora.getDate() + ((SORTEIO.diaSemana - dia + 7) % 7));
  prox.setHours(SORTEIO.hora, SORTEIO.minuto, 0, 0);
  return prox;
}
function atualizarContador() {
  const agora = new Date();
  const alvo = proximoSabado11();
  const diff = alvo - agora;
  const el = document.getElementById("contador");
  if (diff <= 0) {
    el.textContent = "Sorteio em andamento!";
  } else {
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    const s = Math.floor((diff%60000)/1000);
    el.textContent = `${h}h ${m}m ${s}s`;
  }
}
setInterval(atualizarContador, 1000);
atualizarContador();

// ===== Controle Organizador =====
const SENHA = "88832305";
let orgLiberado = false;
const senhaInput = document.getElementById("senhaOrg");
if (senhaInput) {
  senhaInput.addEventListener("input", () => {
    if (senhaInput.value === SENHA) {
      orgLiberado = true;
      renderLista();
      exportar.classList.remove("hidden");
    } else {
      orgLiberado = false;
      renderLista();
      exportar.classList.add("hidden");
    }
  });
}
// ================================

// Inicializar
renderLista();
renderStatus();
</script>
</body>
</html>
